@using Fast.Web.Resources;
@{
    ViewBag.Title = "Insert CasePacker";
}

@section Styles{
    <style>

        .tableWrapper {
            overflow-y: auto;
            max-height: 150px;
        }

            .tableWrapper table {
                border-collapse: collapse;
                width: 100%;
            }

            .tableWrapper thead th, .tableWrapper thead td {
                position: sticky;
                background: #066fcb;
                z-index: 100;
                border: none;
            }

            .tableWrapper table tfoot td {
                position: sticky;
                bottom: 0;
                z-index: 100;
            }

            .tableWrapper .input td {
                background: white;
            }

            .tableWrapper .summary-body td {
                font-weight: bold;
                background-color: #d8eafe;
                color: #000;
            }

        .fa {
            padding: 5px;
        }

        .input-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .input-img-card {
            margin-left: 5px;
            margin-right: 5px;
        }

        .modal-body {
            position: relative;
            margin-top: 10px;
        }

            .modal-body .close {
                padding: 5px;
                position: absolute;
                top: -5px;
                right: 5px;
                font-size: 15px;
                color: black;
                z-index: 1000;
            }

        .stepper {
            position: relative;
        }

            .stepper:before {
                top: 15px;
                bottom: 0;
                position: absolute;
                content: " ";
                width: 100%;
                height: 1px;
                background: #f1f1f1;
                z-index: 0;
            }


        .stepper-step {
            text-align: center;
            position: relative;
        }

            .stepper-step.active .stepper-btn {
                background: #37b6fa;
                color: white;
                font-weight: 500;
                border: 0
            }

        .stepper-btn {
            width: 30px;
            height: 30px;
            text-align: center;
            padding: 6px 0;
            font-size: 12px;
            line-height: 1.428571429;
            border-radius: 15px;
            background: #e6e6e6;
            color: #9c9c9c;
        }

        .wizard-button {
            margin: 5px;
        }

            .wizard-button.active {
                filter: brightness(0.75);
            }
    </style>
}


<div class="content content-fixed lph-form">
    <div class="container-fluid pd-x-0 pd-lg-x-10 pd-xl-x-0">
        <div class="d-sm-flex align-items-center justify-content-between mg-b-20 mg-lg-b-25 mg-xl-b-30">
            <div>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb breadcrumb-style1 mg-b-10">
                        <li class="breadcrumb-item"><a href="#">LPH Form</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Case Packer</li>
                    </ol>
                </nav>
                <h4 class="mg-b-0 tx-spacing--1">LPH Case Packer</h4>
            </div>
            <div class="d-none d-md-block">
                <button class="btn btn-sm pd-x-15 btn-white btn-uppercase mg-l-5"><i data-feather="chevron-left" class="wd-10 mg-r-5"></i> Prev</button>
                <a href="@Url.Action("Index", "History")" class="btn btn-sm pd-x-15 btn-primary btn-uppercase mg-l-5"><i data-feather="clock" class="wd-10 mg-r-5"></i> History</a>
                <button class="btn btn-sm pd-x-15 btn-white btn-uppercase" id="top_photo" data-toggle="modal" data-target="#photo-modal" onclick="infoId(this)"><i data-feather="camera" class="wd-10 mg-r-5"></i> Photo</button>
                <button class="btn btn-sm pd-x-15 btn-white btn-uppercase" id="btnSave"><i data-feather="save" class="wd-10 mg-r-5"></i> Save</button>
                <button class="btn btn-sm pd-x-15 btn-white btn-uppercase mg-l-5"><i data-feather="printer" class="wd-10 mg-r-5"></i> Print</button>
            </div>
        </div>
        <div class="row">
            <div class="col-12 mg-b-20">
                <div class="card" id="generalInfo">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">Information</div>
                    <div class="card-body d-flex">
                        <div class="flex-1">
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Date</label>
                                <div class="col-5">
                                    <input type="text" class="form-control" id="txtDateInfo" disabled value="">
                                </div>
                                <label class="col-2 col-form-label tx-right">Week</label>
                                <div class="col-2">
                                    <input type="text" class="form-control" id="txtWeekNumber" disabled value="">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Machine</label>
                                <div class="col-4">
                                    <input type="text" class="form-control" id="machInfo" disabled value="S50">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Brand</label>
                                <div class="col-9">
                                    <input type="text" class="form-control" id="brandInfo" disabled value="U Mild 12">
                                </div>
                            </div>
                        </div>
                        <div class="divider-text divider-vertical"></div>
                        <div class="flex-1">
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Prodtech</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="prodTech" disabled value="80404805 - Agung Dwi Prasetyo">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Foreman</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="foreman" disabled>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-3 col-form-label">Mekanik</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="mekanik" disabled value="80011429 - Jono">
                                </div>
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Electric</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="elektrik" disabled>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Team Leader</label>
                                <div class="col-8">
                                    <input type="text" class="form-control" id="teamLeader" disabled value="80011827 - Djasmadi">
                                </div>
                            </div>
                        </div>
                        <div class="divider-text divider-vertical"></div>
                        <div class="flex-1">
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Shift / Group</label>
                                <div class="col-3">
                                    <input type="text" class="form-control" id="shift" disabled value="3">
                                </div>
                                <label class="col-1 col-form-label tx-center">/</label>
                                <div class="col-3">
                                    <input type="text" class="form-control" id="group" disabled value="C">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Start / Stop</label>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input id="inputTimeStart" class="form-control input-time" value="22:00">
                                    </div>
                                </div>
                                <label class="col-1 col-form-label">/</label>
                                <div class="col-3">
                                    <div class="input-group">
                                        <input id="inputTimeStop" class="form-control input-time" value="06:00">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div> <!--INFORMATION-->

            <div class="col-12 mg-b-20">
                <div class="card">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">
                        Machine Problems
                    </div>
                    <div class="card-body">
                        <div class="tableWrapper" style="max-height: 210px">
                            <table class="table table-bordered table-hover table-striped" id="dtMachineProblem">
                                <thead class="thead-info">
                                    <tr>
                                        <th>Downtime</th>
                                        <th>Problem</th>
                                        <th>Description</th>
                                        <th style="width:6%;">Start</th>
                                        <th style="width:6%;">End</th>
                                        <th style="width:6%;">Duration</th>
                                        <th>PIC</th>
                                        <th>Status</th>
                                        <th>Action Plan</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="machine-problem">
                                    
                                </tbody>

                                <tfoot>
                                    <tr class="input">
                                        <td>
                                            <select class="form-control select2">
                                                <option value="">Choose one</option>
                                                <option value="301 Minor Stop">301 Minor Stop</option>
                                                <option value="302 Proces Adjustment">302 Proces Adjustment</option>
                                                <option value="401 Breakdown">401 Breakdown</option>
                                                <option value="501 Distruption of Material Flow">501 Distruption of Material Flow</option>
                                                <option value="601 Cleaning">601 Cleaning</option>
                                            </select>
                                        </td>
                                        <td><input type="text" class="form-control"></td>
                                        <td><input type="text" class="form-control"></td>
                                        <td><input class="form-control input-time timeStart" onblur="javascript:countDuration(this)"></td>
                                        <td><input class="form-control input-time timeEnd" onblur="javascript:countDuration(this)"></td>
                                        <td><input type="text" class="form-control timeDif" disabled="" value="0 Min"></td>
                                        <td><input type="text" class="form-control"></td>
                                        <td>
                                            <select class="form-control select2">
                                                <option value="">Choose one</option>
                                                <option value="Done">Done</option>
                                                <option value="On Progres">On Progres</option>
                                                <option value="Pending">Pending</option>
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-control select2">
                                                <option value="">Choose one</option>
                                                <option value="SLAC">SLAC</option>
                                                <option value="CBM">CBM</option>
                                                <option value="PM">PM</option>
                                            </select>
                                        </td>
                                        <td class="tx-center"><i onclick="javascript:addRow(this)" data-target="machine-problem" class="fa fa-plus-circle"></i></td>
                                    </tr>

                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div> <!-- PROBLEM MESIN -->

            <div class="col-3 mg-b-20">
                <div class="card">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">Capture by Webcam</div>
                    <div class="card-body d-flex">
                        <div class="flex-1">
                            <div class="form-group row">
                                <div class="col-12" id="image_1">
                                    <center>
                                        <img src="~/Content/dashforge/assets/img/upload-img-mini.png" id="image_1" class="input-img rounded mx-auto d-block" onclick="infoId(this)" data-toggle="modal" data-target="#photo-modal" alt="insert image" width="auto">
                                    </center>
                                </div>
                                <div class="col-12">
                                    <center>
                                        <label class="col-12 col-form-label"><i>Barcode CBL</i></label>
                                    </center>
                                </div>
                            </div>
                        </div><!-- FOTO PRODUKSI-->
                    </div>
                </div>
            </div>

            <div class="col-2 mg-b-20">
                <div class="card" id="productInfo">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">
                        Product Information
                    </div>
                    <div class="card-body d-flex">
                        <div class="flex-1">
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Result</label>
                                <div class="col-5">
                                    <input type="number" onkeypress="validateNumber(event)" id="result" class="form-control" value="0">
                                </div>
                                <label class="col-3 col-form-label">Box</label>
                            </div>
                            <div class="form-group row">
                                <label class="col-12 col-form-label tx-center"><b>Remaining</b></label>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Bal</label>
                                <div class="col-5">
                                    <input type="number" onkeypress="validateNumber(event)" id="bal" class="form-control" value="0">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label">Slof</label>
                                <div class="col-5">
                                    <input type="number" onkeypress="validateNumber(event)" id="slof" class="form-control" value="0">
                                </div>
                            </div>
                            @*<div class="form-group row">
                                    <label class="col-4 col-form-label">Claimable</label>
                                    <div class="col-5">
                                        <input type="text" class="form-control" disabled value="5">
                                    </div>
                                    <label class="col-2 col-form-label">Pack</label>
                                </div>*@
                        </div>
                        @*<div class="divider-text divider-vertical"></div>
                            <div class="flex-1">
                                <div class="form-group row">
                                    <label class="col-12 col-form-label tx-center"><b>Rework</b></label>
                                </div>
                                <hr>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="135">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="135">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="135">
                                    </div>
                                </div>
                            </div>*@<!-- REWORK -->
                        @*<div class="divider-text divider-vertical"></div>
                            <div class="flex-1">
                                <div class="form-group row">
                                    <label class="col-12 col-form-label tx-center"><b>Claim</b></label>
                                </div>
                                <hr>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="Rusak">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="Jelek">
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <div class="col-12">
                                        <input type="text" class="form-control" disabled value="-">
                                    </div>
                                </div>
                            </div>*@<!-- CLAIMABLE-->
                    </div>
                </div>
            </div>

            <div class="col-7 mg-b-20">
                <div class="card">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">Box Reject</div>
                    <div class="card-body">

                        <div class="row" style="margin:0">
                            <div class="tableWrapper col-12" style="max-height:200px">

                                <table class="table table-bordered table-hover table-striped" id="dtBoxReject">
                                    <thead class="thead-info">
                                        <tr>
                                            <th>Nomor shipping case</th>
                                            <th>Weight</th>
                                            <th>Remark</th>
                                            <th>Status</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="box-reject">
                                        
                                    </tbody>
                                    <tfoot>
                                        <tr class="input">
                                            <td><input type="text" class="form-control"></td>
                                            <td><input type="number" id="weight_ajax" class="form-control" readonly></td>
                                            <td><input type="text" class="form-control"></td>
                                            <td><select class="form-control select2"><option label="Choose one"></option><option value="pass" selected>Pass</option><option value="reject">Reject</option></select></td>
                                            <td class="tx-center"><i onclick="javascript:addRow(this)" data-target="box-reject" class="fa fa-plus-circle"></i></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 mg-b-20">
                <div class="card">
                    <div class="card-header bg-primary tx-white tx-center font-weight-bold">Approval</div>
                    <div class="card-body">
                        <table class="table table-bordered table-hover table-striped">
                            <thead class="thead-info">
                                <tr>
                                    <th>Name</th>
                                    <th>Role</th>
                                    <th>Actions</th>
                                    <th style="width:15%;">Date &amp; Time</th>
                                    <th style="width:40%;">Comment</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


        </div><!-- row -->
    </div><!-- container -->
</div><!-- content -->


<div class="modal fade wizard-modal" id="photo-modal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-body">
                <div class="close"><i data-dismiss="modal" class="fa fa-times"></i></div>

                <div id="carousel" class="carousel slide" data-pause="true">
                    <div class="carousel-inner">

                        <div class="carousel-item active">
                            <h5><label id="next-1">Take Picture For 'Barcode 778'</label></h5>
                            <hr />
                            <div class="row">
                                <div class="col-md-6">
                                    <center>
                                        <select id="videoSource"><option value="" selected="selected"></option></select><br />
                                    </center>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <center>
                                        <video autoplay="true" width="160" height="120" id="videoElement"> </video><br />
                                        <button id="snapHat">Capture Image </button><br />
                                    </center>
                                </div>
                                <div class="col-md-6">
                                    <center>
                                        <canvas id="snapshot"></canvas><br />
                                        <p id="demo"></p>

                                        <button id="capture" hidden>Read PDF417</button>  @*don't remove *@
                                        <button id="capture3" hidden>OCR ID </button>  @*don't remove*@
                                        <button id="saveText" hidden>Save Text + Image </button>   @*don't remove *@
                                    </center>
                                </div>
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script src="~/Content/dashforge/lib/cleave.js/cleave.min.js"></script>
    <script src="~/Content/dashforge/lib/select2/js/select2.min.js"></script>
    <script src="~/Content/dashforge/lib/moment/moment.js"></script>

    <script src="~/Scripts/webcam_help/main.js"></script>
    <script src="~/Scripts/webcam_help/MRZ_417_230119.js"></script>

    <script>
        function basicFunction() {
            $('.select2').click({
                placeholder: 'Choose one',
                searchInputPlaceholder: 'Search options'
            });

            $(document).find('.input-time').each(function () {
                var cleave = new Cleave($(this), {
                    time: true,
                    timePattern: ['h', 'm']
                });
            })
        }
        function addRow(e) {
            $body = $(e).closest('tfoot').prev();

            flag = true;
            $(e).closest('tfoot').find('input, select').each(function () {
                if ($(this).val() == "") {
                    flag = false;
                    return false;
                }
            })

            if (flag) {
               var string = "<tr>";
                $(e).closest('tfoot').find('td').each(function () {
                    $(this).find('input, select').each(function () {
                        string += "<td>"+$(this).val()+"</td>";
                    });
                });
                string += '<td class="tx-center"><div class="btn-group"><i onclick="javascript:toEdit(this)" class="fa fa-edit"></i><i onclick="javascript:removeRow(this)" class="fa fa-trash"></i></div></td>';
                string += "</tr>";

                $body.append(string);

                $(e).closest('tfoot').find('input, select').each(function () {
                    $(this).val('');
                })
            } else {
                alert("Value can't be empty");
            }
        }
        function removeRow(e) {
            if (confirm('Are you sure?')) {
                $(e).parents("tr").remove();
            }
        }
        function toEdit(e) {
            $tr = $(e).closest('tr');
            var counter = 0;

            if ($(e).closest('tbody').attr('id') == 'machine-problem') {
                $tr.find('td').each(function () {
                    var string = '';
                    if (counter == 0) {
                        string = `<select class="form-control select2">
                                    <option value="">Choose one</option>
                                    <option value="301 Minor Stop">301 Minor Stop</option>
                                    <option value="302 Proces Adjustment">302 Proces Adjustment</option>
                                    <option value="401 Breakdown">401 Breakdown</option>
                                    <option value="501 Distruption of Material Flow">501 Distruption of Material Flow</option>
                                    <option value="601 Cleaning">601 Cleaning</option></select>`;
                        string = string.replace($(this).text() + '"', $(this).text() + '" selected');
                    } else if (counter == 7) {
                        string = `<select class="form-control select2">
                                    <option value="">Choose one</option>
                                    <option value="Done">Done</option>
                                    <option value="On Progres">On Progres</option>
                                    <option value="Pending">Pending</option></select>`;
                        string = string.replace($(this).text() + '"', $(this).text() + '" selected');
                    } else if (counter == 8) {
                        string = `<select class="form-control select2">
                                    <option value="">Choose one</option>
                                    <option value="SLAC">SLAC</option>
                                    <option value="CBM">CBM</option>
                                    <option value="PM">PM</option></select>`;
                        string = string.replace($(this).text() + '"', $(this).text() + '" selected');
                    } else if (counter == 3) {
                        string = '<input class="form-control input-time timeStart" onblur="javascript:countDuration(this)" value="' + $(this).text() + '">';
                    } else if (counter == 4) {
                        string = '<input class="form-control input-time timeEnd" onblur="javascript:countDuration(this)" value="' + $(this).text() + '">';
                    } else if (counter == 5) {
                        string = '<input class="form-control timeDif" disabled="" value="' + $(this).text() + '">';
                    } else if (counter == 9) {
                        $(this).addClass('tx-center');
                        string = '<i data-target="machine-problem" onclick="javascript:toSave(this)" class="fa fa-save"></i><i onclick="javascript:removeRow(this)" data-target="machine-problem" class="fa fa-trash"></i>';
                    } else {
                        string = '<input type="text" class="form-control" value="' + $(this).text() + '">';
                    }
                    $(this).html(string);
                    counter++;
                })
            } else {
                $tr.find('td').each(function () {
                    var string = '';
                    if (counter == 3) {
                        string = `<select class="form-control select2">
                                    <option value="">Choose one</option>
                                    <option value="pass" selected="">Pass</option>
                            <option value="reject">Reject</option></select>`;
                        string = string.replace($(this).text() + '"', $(this).text() + '" selected');
                    } else if (counter == 4) {
                        $(this).addClass('tx-center');
                        string = '<i data-target="machine-problem" onclick="javascript:toSave(this)" class="fa fa-save"></i><i onclick="javascript:removeRow(this)" data-target="machine-problem" class="fa fa-trash"></i>';
                    } else if (counter == 1) {
                        string = '<input type="number" onkeypress="validateNumber(event)" class="form-control" value="' + $(this).text() + '">';
                    } else {
                        string = '<input type="text" class="form-control" value="' + $(this).text() + '">';
                    }
                    $(this).html(string);
                    counter++;
                })
            }

            basicFunction();
        }

        function toSave(e) {
            $tr = $(e).closest('tr');
            flag = true;

            $tr.find('input, select').each(function () {
                if ($(this).val() == "") {
                    flag = false;
                    return false;
                }
            })

            if (flag) {
                var $td;
                $tr.find('td').each(function () {
                    $td = $(this);
                    $(this).find('input, select').each(function () {
                        $td.text($(this).val());
                        return false;
                    });
                })
                $td.html('<div class="btn-group"><i onclick="javascript:toEdit(this)" class="fa fa-edit"></i><i onclick="javascript:removeRow(this)" class="fa fa-trash"></i></div>');
            } else {
                alert("Value can't be empty");
            }
        }

        function countDuration(e) {
            $tr = $(e).closest('tr');
            var start = $tr.find('.timeStart').first().val();
            var end = $tr.find('.timeEnd').first().val();

            if (start != "" && end != "") {
                end = end.split(':');
                start = start.split(':');
                var d = new Date();
                var startdate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), start[0], start[1]);
                var enddate = new Date(d.getFullYear(), d.getMonth(), d.getDate(), end[0], end[1]);

                var diffTime = enddate - startdate;
                var diffMinutes = Math.ceil(diffTime / 60000);

                $tr.find('.timeDif').first().val(diffMinutes + " Min");
            }
        };

        function oneSecondFunction() {
            $.ajax({
                url: "http://localhost:17709/scalereader/weight",
                type: 'GET',
                dataType: 'json',
                success: function(res) {
                    console.log(res);
                    $('#weight_ajax').val(res.weight);
                }
            });
        }

        $(function () {
            'use strict'

            $('#txtDateInfo').val(moment().format("ddd, DD-MMM-YY"));
            $('#txtWeekNumber').val(moment().week());

            setInterval(oneSecondFunction, 1000);

            basicFunction();

            $('#btnSave').click(function () { $('#loading_overlay').removeClass('d-none');
              var timeStart = $('#inputTimeStart').val();
              var timeStop = $('#inputTimeStop').val();

                var collectorArray = []; // for LPH Extras
                $("#dtMachineProblem tbody").find('tr').each(function () {
                    var counter = -1; counter++;
                    $(this).find('td').each(function () {
                        var $th = $("table thead tr th").eq($(this).index()).text();

                        if ($th.trim() != "") {
                            var tempArray = {};
                            tempArray.HeaderName = "Machine Problems";
                            tempArray.FieldName = $th;
                            tempArray.Value = $(this).text();
                            tempArray.ValueType = "NonNumeric";
                            tempArray.Shift = $('#shift').val();
                            tempArray.RowNumber = counter;
                            collectorArray.push(tempArray);
                        }

                    });

                });

                $("#dtBoxReject tbody").find('tr').each(function () {
                    var counter = -1; counter++;
                    $(this).find('td').each(function () {
                        var $th = $("table thead tr th").eq($(this).index()).text();

                        if ($th.trim() != "") {
                            var tempArray = {};
                            tempArray.HeaderName = "Box Reject";
                            tempArray.FieldName = $th;
                            tempArray.Value = $(this).text();
                            tempArray.ValueType = ($th == "Weight")?"Numeric":"NonNumeric";
                            tempArray.Shift = $('#shift').val();
                            tempArray.RowNumber = counter;
                            collectorArray.push(tempArray);
                        }

                    });

                });

                var detailSubmission = {};
                var collectorComponent = [];
                var collectorValue = [];

                detailSubmission.StartTime = timeStart;
                detailSubmission.EndTime = timeStop;
                detailSubmission.Shift = $('#shift').val();

                /******** COMPONENT ************/
                $('#generalInfo').find('label').each(function () {
                    if ($(this).text().length > 2) {
                        if ($(this).text().includes('/')) {
                            var array = $(this).text().split('/');
                            var compo = {};
                            compo.ComponentType="textfield";
                            compo.ComponentName = array[0].trim();
                            collectorComponent.push(compo);
                            var compo = {};
                            compo.ComponentType="textfield";
                            compo.ComponentName = array[1].trim();
                            collectorComponent.push(compo);
                        } else {
                            var compo = {};
                            compo.ComponentType="textfield";
                            compo.ComponentName = $(this).text();
                            collectorComponent.push(compo);
                        }
                    }
                })
                $('#productInfo').find('.form-group>label').each(function () {
                    if ($(this).text() != 'Remaining' && $(this).text() != 'Box') {
                        var compo = {};
                        compo.ComponentType="textfield";
                        compo.ComponentName = $(this).text();
                        collectorComponent.push(compo);
                    }
                })

                /***************** VALUE ******************/
                $('#generalInfo, #productInfo').find('input').each(function () {
                    var compo = {};
                    compo.Value = $(this).val();
                    compo.ValueType = "NonNumeric";

                    if ($(this).attr('type') == "number")
                        compo.ValueType = "Numeric";

                    collectorValue.push(compo);
                })

                /*
                var imgUrl1 = $("#image_1").find('img').first().attr('src');
                var imageUrl1 = {};
                imageUrl1.ComponentType="imagefield";
                imageUrl1.ComponentName = "Image1";
                imageUrl1.ImagePath = imgUrl1;
                collectorComponent.push(imageUrl1);

                var compo = {};
                compo.Value = imgUrl1;
                compo.ValueType = "Image";
                collectorValue.push(compo);
                */

                console.log(collectorComponent);
                console.log(collectorValue);

                $.ajax({
                  type: "POST",
                  url: "@Url.Action("Create", "CasePacker")",
                  data: JSON.stringify({
                      detailExtras: collectorArray,
                      detailSubmission: detailSubmission,
                      detailComponent: collectorComponent,
                      detailValue: collectorValue
                  }),
                  contentType: "application/json; charset=utf-8",
                  dataType: "json",
                  success: function (result) {
                      console.log(result.Status);
					if (result.Status == 'True') {
						var notice = new PNotify({
							title: "@UIResources.Confirmation",
							text: "@UIResources.CreateSucceed",
							width: "400px",
							type: 'success',
							addclass: 'stack-bottomright'
						});

						notice.get().click(function () {
							notice.remove();
                        });

                        setTimeout(function () {
                            location.reload();
                        }, 3000);
					}
					else {
						var notice = new PNotify({
							title: "@UIResources.ErrorMessage",
							text: "@UIResources.CreateFailed",
							width: "400px",
                            type: 'error',
                            addclass: 'stack-bottomright',
							hide: false,
							buttons: {
								sticker: false
							}
						});

						notice.get().click(function () {
								notice.remove();
							});
						}
                    },
                      error: function (request, status, error) {
                            window.location.reload(true); 
                      },
                        complete: function() {
                            $('#loading_overlay').addClass('d-none');
                        },
                });
            });
        })
    </script>





    <script>
        var isImg = [];
        var imgContent = [];
        var imageIndex = 0;
        var max = 1;

        var selected = null;

        $(document).ready(function () {
            $('.tableWrapper thead tr').each(function () {
                //const top = $(this).position().top;
                $(this).children().css({ "top": 0 });
            });
            $('.wizard-modal').on('hidden.bs.modal', function (e) {
                const carousel = $(this).find('.carousel');
                const stepper = $(this).find('.stepper');
                $(this).find('.active').removeClass("active");
                $(stepper).children(".stepper-step:first-child").toggleClass("active");
                $(carousel).find(".carousel-item:first-child").toggleClass("active");
                $(this).trigger("hide");
                $(this).find(".prev").hide();
            });

            $('#photo-modal').on('hide', function (e) {
            });
        });

        function infoId(e) {
            console.log(e.id);

            for (var i = 0; i < max; i++) {
                if (e.id == "image_" + (i + 1)) {
                    isImg[i] = true;
                } else {
                    isImg[i] = false;
                }
                if (e.id == "top_photo") {
                    isImg[0] = true;
                }
            }
        }

        function renderImage(link, state) {

            if (link == null || link == "") {
                isUrlLink = false;
            }
            else {

                isUrlLink = true;
                console.log("link " + link);
                console.log("state: " + state);

                for (var i = 0; i < max; i++) {
                    if (state == "image_" + (i + 1) + "") {
                        imgContent[i] = link;
                        document.getElementById("image_" + (i + 1)).innerHTML = '<img class="input-img rounded mx-auto d-block" src=' + imgContent[i] + ' id="image_' + (i + 1) + '" data-toggle="modal" data-target="#photo-modal" />';
                    }
                }
            }
        }

        $("#t_barcode778").click(function () {
            isImg[0] = true;
        });


        // Video Part
        var video = document.querySelector("#videoElement");
        var hdConstraints = { video: { mandatory: { minWidth: 160, minHeight: 120 } } };
        var hhdConstraints = { video: { mandatory: { minWidth: 160, minHeight: 120 } } };
        var vgaConstraints = {
            video: {
                mandatory: {
                    maxWidth: 160,
                    maxHeight: 120
                }
            }
        };
        navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia || navigator.oGetUserMedia;

        if (navigator.getUserMedia) {
            document.getElementById("demo").innerHTML = "";

            try {
                navigator.getUserMedia(hhdConstraints, handleVideo, videoError);
            } catch (error) {
                navigator.getUserMedia(hdConstraints, handleVideo, videoError);
            }
        }

        function handleVideo(stream) {
            try {
                this.srcObject = stream;
            } catch (error) {
                this.src = window.URL.createObjectURL(stream);
            }
        }

        function videoError(e) {
            // do something
        }

        // Capture Image Part
        var player = document.getElementById('videoElement');
        var snapshotCanvas = document.getElementById('snapshot');
        var captureButton = document.getElementById('capture');
        var captureButton3 = document.getElementById('capture3');
        var textBottom = document.getElementById('saveText');

        var canvas = document.querySelector('canvas');
        var ctx = canvas.getContext('2d');
        var txfname = "img_text";
        var XdatStr = 'date';

        textBottom.addEventListener('click', function () {
            var temp = new Date();
            var minth = 1 + temp.getMonth();
            var dateStr = temp.getFullYear() + '_' +
                minth + '_' +
                temp.getDate() + '-' +
                temp.getHours() + '_' +
                temp.getMinutes() + '_' +
                temp.getSeconds();
            XdateStr = dateStr;
            txfname = 'IMG_' + dateStr;

            saveTextAsFile(txfname);
            pcanvas2blob().then(download2X);

            document.getElementById("demo").innerHTML = "saved ";

        });

        captureButton.addEventListener('click', function () {
            document.getElementById("demo").innerHTML = "Reading PDF417.";

            var VH = 1080;
            var VW = 1920;

            VH = video.videoHeight;
            VW = video.videoWidth;

            ctx.canvas.width = VW;
            ctx.canvas.height = VH;

            ctx.drawImage(video, 0, 0);


            var imgd = ctx.getImageData(0, 0, VW, VH);
            var pix = imgd.data;

            var nDataBytes = VH * VW * 4;

            var pdf417Heap = new Uint8Array(Module.HEAPU8.buffer, 1028);

            var buf = Module._malloc(nDataBytes);
            Module.HEAPU8.set(pix, buf);

            // Draw the ImageData at the given (x,y) coordinates.
            ctx.putImageData(imgd, 0, 0);

            var b = _pdf417JS(buf, VH, VW, 1024);

            var heapBu = new Uint8Array(Module.HEAPU8.buffer, buf, 1028);
            var vanz = bin2Strung(heapBu);


            if (b <= 0) {
                vanz = "No Read.";
            }

            Module._free(buf);
            document.getElementById("demo").innerHTML = vanz;

        });

        captureButton3.addEventListener('click', function () {
            document.getElementById("demo").innerHTML = " OCRing MRZ. ";

            var VH = 1080;
            var VW = 1920;
            VH = video.videoHeight;
            VW = video.videoWidth;

            ctx.canvas.width = VW;
            ctx.canvas.height = VH;

            ctx.drawImage(video, 0, 0);

            var imgd = ctx.getImageData(0, 0, VW, VH);
            var pix = imgd.data;

            var nDataBytes = VH * VW * 4; //1280*720*4;

            var pdf417Heap = new Uint8Array(Module.HEAPU8.buffer, 1028);

            var bluf = Module._malloc(nDataBytes);
            Module.HEAPU8.set(pix, bluf);


            // Draw the ImageData at the given (x,y) coordinates.
            ctx.putImageData(imgd, 0, 0);

            var c = _DLreadJS(bluf, VH, VW, 1024);

            var heapBuc = new Uint8Array(Module.HEAPU8.buffer, bluf, 1028);
            var vanc = bin2Strung(heapBuc);

            if (c <= 0) {
                vanc = "No Read.";
            }
            Module._free(bluf);
            document.getElementById("demo").innerHTML = vanc;
        });

        snapHat.addEventListener('click', function () {
            document.getElementById("demo").innerHTML = "Image captured";

            takeASnap();
            //.then(download);
        });

        var state = "";
        function takeASnap() {

            canvas.width = 160;//video.videoWidth; // set its size to the one of the video
            canvas.height = 120;// video.videoHeight;
            ctx.drawImage(video, 0, 0, 160, 120); // the video

            var jpegUrl = ctx.canvas.toDataURL("image/jpeg"); // get base64 output - no longer using toBlob

            for (var i = 0; i < max; i++) {
                if (isImg[i] == true) {
                    state = "image_" + (i + 1);
                }
            }
            renderImage(jpegUrl, state);
        }

        function pcanvas2blob() {
            return new Promise((res, rej) => {
                canvas.toBlob(res, 'image/jpeg'); // request a Blob from the canvas
            });
        }

        function download2X(blob) {
            // uses the <a download> to download a Blob
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);

            a.download = 'IMG_' + XdateStr + '.jpg';
            document.body.appendChild(a);
            a.click();
        }

        function download(blob) {
            // uses the <a download> to download a Blob
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            var temp = new Date();
            var minth = 1 + temp.getMonth();
            var dateStr = temp.getFullYear() + '_' +
                minth + '_' +
                temp.getDate() + '-' +
                temp.getHours() + '_' +
                temp.getMinutes() + '_' +
                temp.getSeconds();

            a.download = 'IMG_' + dateStr + '.jpg';
            document.body.appendChild(a);
            a.click();
        }


        function download_png(blob) {
            // uses the <a download> to download a Blob
            let a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            var temp = new Date();
            var minth = 1 + temp.getMonth();
            var dateStr = temp.getFullYear() + '_' +
                minth + '_' +
                temp.getDate() + '-' +
                temp.getHours() + '_' +
                temp.getMinutes() + '_' +
                temp.getSeconds();
            a.download = 'IMG_' + dateStr + '.png';
            document.body.appendChild(a);
            a.click();
        }

        function canvaSnap() {
            return new Promise((res, rej) => {
                canvas.toBlob(res, 'image/png'); // request a Blob from the canvas
            });
        }

        function saveTextAsFile(txt_name) {

            var ocr_text = document.getElementById("demo").innerHTML
            var res = ocr_text.replace(/<br>/g, "\r\n");
            var res2 = res.replace(/&lt;/g, '<');

            var blab = new Blob([res2], { type: 'text/plain' });

            let a = document.createElement('a');
            a.href = URL.createObjectURL(blab);
            a.download = txt_name + '.txt';
            document.body.appendChild(a);

            a.click();
        }

        function saveImageAndText(fname) {

            var ocr_text = document.getElementById("demo").innerHTML
            var blab = new Blob([ocr_text], { type: 'text/plain' });

            let a = document.createElement('a');
            a.href = URL.createObjectURL(blab);
            a.download = txt_name + '.txt';
            document.body.appendChild(a);
            a.click();
        }

        function bin2Strung(array) {
            var result = "";
            var max = 2048;
            for (var i = 0; i < max; i++) {
                var v = String.fromCharCode(array[i]);

                if (array[i] == 10) {
                    result += "<br/>";
                }
                else {
                    if (array[i] == 60) {
                        //result += "&#60";
                        result += "&lt";
                    }
                    else {
                        result += String.fromCharCode(array[i]);
                    }
                }
                if (array[i] == 0) {
                    i = max;
                }
            }
            return result;
        }
    </script>
}